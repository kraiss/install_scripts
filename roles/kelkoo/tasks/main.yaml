---
- name: Install kelkoo packages
  become: true
  ansible.builtin.dnf:
    name: "{{ item }}"
    state: latest
  loop:
    - ca-certificates-kelkoogroup
    - kelkoo-dev-tools 
    - java-21-openjdk-devel
    - discord
- name: Install additional firefox codec (see https://pagure.io/fedora-workstation/issue/84) 
  become: true
  ansible.builtin.dnf:
    name: "{{ item }}"
    state: latest
  loop:
    - gstreamer1-plugin-openh264
    - mozilla-openh264
- name: Maven
  block:
    - name: Maven - Remove conflicting if present
      become: true
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: absent
      loop:
        - maven
        - maven-lib
    - name: Maven - Create workdirs
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
      loop:
        - "~/.m2"
        - "~/apache-maven"
    - name: Maven - Configure Kelkoo Maven repos
      ansible.builtin.get_url:
        url: "{{ kelkoo.maven.settings }}"
        dest: "~/.m2/settings.xml"
        mode: '0644'
    - name: Maven - shell config 
      ansible.builtin.copy:
        src: "files/.kelkoorc"
        dest: "~/.kelkoorc"
        mode: '0644'
    - name: Maven - shell config import
      ansible.builtin.lineinfile:
        path: "{{ item }}"
        line: "source ~/.kelkoorc"
      loop: 
        - "~/.bashrc"
        - "~/.zshrc"
    - name: Maven - Download binaries
      ansible.builtin.unarchive:
        src: "{{ kelkoo.maven.package }}"
        dest: "~/apache-maven"
        remote_src: yes
- name: sbt
  block:
    - name: sbt - Install sbt
      become: true
      ansible.builtin.dnf:
        name: "sbt"
        state: latest
    - name: sbt - Create workdirs
      ansible.builtin.file:
        path: "~/.sbt"
        state: directory
    - name: sbt - Add build repo override option
      become: true
      ansible.builtin.lineinfile:
        path: "/etc/sbt/sbtopts"
        line: "-Dsbt.override.build.repos=true"
    - name: sbt - Configure kelkoo sbt repos
      ansible.builtin.copy:
        src: "files/sbt-repositories"
        dest: "~/.sbt/repositories"
        mode: '0644'
- name: npm
  block:
    - name: npm - Install nodejs/npm
      become: true
      ansible.builtin.dnf:
        name: "nodejs"
        state: latest
    - name: npm - Add kelkoo repo configs
      ansible.builtin.shell: "npm config set {{ item }}" 
      loop:
        - "registry=https://artifactory.corp.kelkoo.net/artifactory/api/npm/npm-remote-repos/"
        - "@kelkoo:registry=https://artifactory.corp.kelkoo.net/artifactory/api/npm/npm-release-local/"
        - "cafile /usr/share/pki/ca-trust-source/anchors/ca-kelkoogroup-2019.pem"
- name: Python
  block:
    - name: Python - Install python-pip
      become: true
      ansible.builtin.dnf:
        name: "python3-pip"
        state: latest
    - name: Python - Create pip conf dir
      ansible.builtin.file:
        path: "~/.config/pip/"
        state: directory
    - name: Python - Add pip config
      ansible.builtin.copy:
        src: "files/pip.conf"
        dest: "~/.config/pip/pip.conf"
        mode: '0644'
- name: podman
  block:
    - name: podman - Install podman
      become: true
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: latest
      loop: 
        - podman
        - podman-docker
    - name: podman - Create pip conf dir
      ansible.builtin.file:
        path: "~/.config/containers/"
        state: directory
    - name: podman - Add pip config
      ansible.builtin.copy:
        src: "files/registries.conf"
        dest: "~/.config/containers/registries.conf"
        mode: '0644'
      